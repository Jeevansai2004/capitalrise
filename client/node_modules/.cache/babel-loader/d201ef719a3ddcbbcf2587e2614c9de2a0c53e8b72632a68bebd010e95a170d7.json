{"ast":null,"code":"import React,{useEffect,useRef,useState}from'react';import{useAuth}from'../context/AuthContext';import io from'socket.io-client';import Button from'./Button';import moment from'moment-timezone';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const socket=io('http://localhost:5000',{autoConnect:false});export default function ChatBox(){const{user,token}=useAuth();const[messages,setMessages]=useState([]);const[input,setInput]=useState('');const[open,setOpen]=useState(false);const messagesEndRef=useRef(null);useEffect(()=>{if(!user||!open)return;socket.connect();socket.emit('join-client',user.id);fetchMessages();socket.on('new-message',msg=>{setMessages(m=>[...m,msg]);});return()=>{socket.off('new-message');socket.disconnect();};// eslint-disable-next-line\n},[user,open]);useEffect(()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});},[messages]);const fetchMessages=async()=>{const res=await fetch('/api/chat/messages',{headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});const data=await res.json();if(data.success)setMessages(data.data);};const sendMessage=async e=>{e.preventDefault();if(!input.trim())return;// Save to DB\nawait fetch('/api/chat/messages',{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({message:input})});// Emit for real-time\nsocket.emit('send-message',{message:input,sender_id:user.id,sender_name:user.username,sender_role:user.role,created_at:new Date().toISOString()});setInput('');};// Show a small open button when chat is closed\nif(!open){return/*#__PURE__*/_jsx(\"button\",{onClick:()=>setOpen(true),style:{position:'fixed',bottom:32,right:32,width:64,height:64,borderRadius:12,background:'#2563eb',color:'white',border:'none',boxShadow:'0 2px 8px rgba(0,0,0,0.15)',zIndex:1001,display:'flex',alignItems:'center',justifyContent:'center',fontSize:20,fontWeight:600,cursor:'pointer',letterSpacing:1},\"aria-label\":\"Open chat\",children:\"Chat\"});}// Show the chatbox when open\nreturn/*#__PURE__*/_jsxs(\"div\",{style:{position:'fixed',bottom:32,right:32,width:350,maxWidth:'90vw',height:420,background:'white',borderRadius:16,boxShadow:'0 2px 16px rgba(0,0,0,0.18)',display:'flex',flexDirection:'column',zIndex:1001},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',padding:12,borderBottom:'1px solid #eee',background:'#2563eb',color:'white',borderTopLeftRadius:16,borderTopRightRadius:16},children:[/*#__PURE__*/_jsx(\"span\",{style:{flex:1,fontWeight:600},children:\"Chat with Admin\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setOpen(false),style:{background:'none',border:'none',color:'white',fontSize:20,cursor:'pointer',marginLeft:8},\"aria-label\":\"Close chat\",children:\"\\xD7\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,overflowY:'auto',padding:12,background:'#f8fafc'},children:[messages.map((msg,i)=>/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:8},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:4},children:[/*#__PURE__*/_jsxs(\"b\",{children:[msg.sender_name,\":\"]}),/*#__PURE__*/_jsx(\"small\",{style:{color:'#666',fontSize:'11px'},children:msg.formattedTime||(msg.created_at?moment(msg.created_at).tz('Asia/Kolkata').format('DD/MM/YYYY h:mm A'):'')})]}),/*#__PURE__*/_jsx(\"div\",{children:msg.message})]},i)),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:sendMessage,style:{display:'flex',padding:12,borderTop:'1px solid #eee',background:'#f1f5f9',borderBottomLeftRadius:16,borderBottomRightRadius:16},children:[/*#__PURE__*/_jsx(\"input\",{value:input,onChange:e=>setInput(e.target.value),style:{flex:1,borderRadius:8,border:'1px solid #ddd',padding:8,marginRight:8},placeholder:\"Type your message...\"}),/*#__PURE__*/_jsx(Button,{type:\"submit\",children:\"Send\"})]})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","useAuth","io","Button","moment","jsx","_jsx","jsxs","_jsxs","socket","autoConnect","ChatBox","user","token","messages","setMessages","input","setInput","open","setOpen","messagesEndRef","connect","emit","id","fetchMessages","on","msg","m","off","disconnect","_messagesEndRef$curre","current","scrollIntoView","behavior","res","fetch","headers","data","json","success","sendMessage","e","preventDefault","trim","method","body","JSON","stringify","message","sender_id","sender_name","username","sender_role","role","created_at","Date","toISOString","onClick","style","position","bottom","right","width","height","borderRadius","background","color","border","boxShadow","zIndex","display","alignItems","justifyContent","fontSize","fontWeight","cursor","letterSpacing","children","maxWidth","flexDirection","padding","borderBottom","borderTopLeftRadius","borderTopRightRadius","flex","marginLeft","overflowY","map","i","marginBottom","formattedTime","tz","format","ref","onSubmit","borderTop","borderBottomLeftRadius","borderBottomRightRadius","value","onChange","target","marginRight","placeholder","type"],"sources":["C:/Users/saije/Downloads/capital rise/client/src/components/ChatBox.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\nimport { useAuth } from '../context/AuthContext';\r\nimport io from 'socket.io-client';\r\nimport Button from './Button';\r\nimport moment from 'moment-timezone';\r\n\r\nconst socket = io('http://localhost:5000', { autoConnect: false });\r\n\r\nexport default function ChatBox() {\r\n  const { user, token } = useAuth();\r\n  const [messages, setMessages] = useState([]);\r\n  const [input, setInput] = useState('');\r\n  const [open, setOpen] = useState(false);\r\n  const messagesEndRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    if (!user || !open) return;\r\n    socket.connect();\r\n    socket.emit('join-client', user.id);\r\n    fetchMessages();\r\n\r\n    socket.on('new-message', msg => {\r\n      setMessages(m => [...m, msg]);\r\n    });\r\n\r\n    return () => {\r\n      socket.off('new-message');\r\n      socket.disconnect();\r\n    };\r\n    // eslint-disable-next-line\r\n  }, [user, open]);\r\n\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  const fetchMessages = async () => {\r\n    const res = await fetch('/api/chat/messages', {\r\n      headers: {\r\n        'Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json'\r\n      }\r\n    });\r\n    const data = await res.json();\r\n    if (data.success) setMessages(data.data);\r\n  };\r\n\r\n  const sendMessage = async e => {\r\n    e.preventDefault();\r\n    if (!input.trim()) return;\r\n\r\n    // Save to DB\r\n    await fetch('/api/chat/messages', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify({ message: input })\r\n    });\r\n\r\n    // Emit for real-time\r\n    socket.emit('send-message', {\r\n      message: input,\r\n      sender_id: user.id,\r\n      sender_name: user.username,\r\n      sender_role: user.role,\r\n      created_at: new Date().toISOString()\r\n    });\r\n\r\n    setInput('');\r\n  };\r\n\r\n  // Show a small open button when chat is closed\r\n  if (!open) {\r\n    return (\r\n      <button\r\n        onClick={() => setOpen(true)}\r\n        style={{\r\n          position: 'fixed',\r\n          bottom: 32,\r\n          right: 32,\r\n          width: 64,\r\n          height: 64,\r\n          borderRadius: 12,\r\n          background: '#2563eb',\r\n          color: 'white',\r\n          border: 'none',\r\n          boxShadow: '0 2px 8px rgba(0,0,0,0.15)',\r\n          zIndex: 1001,\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          fontSize: 20,\r\n          fontWeight: 600,\r\n          cursor: 'pointer',\r\n          letterSpacing: 1,\r\n        }}\r\n        aria-label=\"Open chat\"\r\n      >\r\n        Chat\r\n      </button>\r\n    );\r\n  }\r\n\r\n  // Show the chatbox when open\r\n  return (\r\n    <div\r\n      style={{\r\n        position: 'fixed',\r\n        bottom: 32,\r\n        right: 32,\r\n        width: 350,\r\n        maxWidth: '90vw',\r\n        height: 420,\r\n        background: 'white',\r\n        borderRadius: 16,\r\n        boxShadow: '0 2px 16px rgba(0,0,0,0.18)',\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        zIndex: 1001,\r\n      }}\r\n    >\r\n      <div style={{ display: 'flex', alignItems: 'center', padding: 12, borderBottom: '1px solid #eee', background: '#2563eb', color: 'white', borderTopLeftRadius: 16, borderTopRightRadius: 16 }}>\r\n        <span style={{ flex: 1, fontWeight: 600 }}>Chat with Admin</span>\r\n        <button\r\n          onClick={() => setOpen(false)}\r\n          style={{ background: 'none', border: 'none', color: 'white', fontSize: 20, cursor: 'pointer', marginLeft: 8 }}\r\n          aria-label=\"Close chat\"\r\n        >\r\n          Ã—\r\n        </button>\r\n      </div>\r\n      <div style={{ flex: 1, overflowY: 'auto', padding: 12, background: '#f8fafc' }}>\r\n        {messages.map((msg, i) => (\r\n          <div key={i} style={{ marginBottom: 8 }}>\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 4 }}>\r\n              <b>{msg.sender_name}:</b>\r\n              <small style={{ color: '#666', fontSize: '11px' }}>\r\n                {msg.formattedTime || (msg.created_at ? moment(msg.created_at).tz('Asia/Kolkata').format('DD/MM/YYYY h:mm A') : '')}\r\n              </small>\r\n            </div>\r\n            <div>{msg.message}</div>\r\n          </div>\r\n        ))}\r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n      <form onSubmit={sendMessage} style={{ display: 'flex', padding: 12, borderTop: '1px solid #eee', background: '#f1f5f9', borderBottomLeftRadius: 16, borderBottomRightRadius: 16 }}>\r\n        <input\r\n          value={input}\r\n          onChange={e => setInput(e.target.value)}\r\n          style={{ flex: 1, borderRadius: 8, border: '1px solid #ddd', padding: 8, marginRight: 8 }}\r\n          placeholder=\"Type your message...\"\r\n        />\r\n        <Button type=\"submit\">Send</Button>\r\n      </form>\r\n    </div>\r\n  );\r\n} "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}